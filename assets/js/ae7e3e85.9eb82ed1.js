"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[8352],{1890:(r,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>u,default:()=>N,frontMatter:()=>c,metadata:()=>e,toc:()=>i});const e=JSON.parse('{"id":"T-SQL/Routines/Stored Procedures/SP Robust Example","title":"SP Robust Example","description":"Contains:","source":"@site/techStack/T-SQL/Routines/Stored Procedures/SP Robust Example.md","sourceDirName":"T-SQL/Routines/Stored Procedures","slug":"/T-SQL/Routines/Stored Procedures/SP Robust Example","permalink":"/DocE80/techStack/T-SQL/Routines/Stored Procedures/SP Robust Example","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"techStack","previous":{"title":"SP Data Manipulation","permalink":"/DocE80/techStack/T-SQL/Routines/Stored Procedures/SP Data Manipulation"},"next":{"title":"Transactions","permalink":"/DocE80/techStack/T-SQL/Transactions/"}}');var o=t(4848),a=t(8453);const c={},u=void 0,d={},i=[];function E(r){const n={code:"code",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...r.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"Contains:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Input Validation"}),"\n",(0,o.jsx)(n.li,{children:"Transaction Protection"}),"\n",(0,o.jsx)(n.li,{children:"Error Handling"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-SQL",children:"USE AdventureWorks2022\r\nGO\r\n\r\nDECLARE @try int = 1, @tries int = 5, @en int = 0\r\nWHILE @try <= @tries BEGIN\r\n    BEGIN TRY\r\n        SELECT 1/0\r\n    END TRY\r\n    BEGIN CATCH\r\n        SELECT @en = ERROR_NUMBER()\r\n        SET @try += 1\r\n    END CATCH\r\nEND\r\nSELECT @en,@try, @tries\r\n\r\n\r\nGO\r\n\r\n\r\nCREATE OR ALTER PROCEDURE Production.AddNewBike \r\n      @SubcategoryName NVARCHAR(50)\r\n    , @ModelName NVARCHAR(50)\r\n    , @ProductName NVARCHAR(50)\r\n    , @ProductNumber NVARCHAR(25)\r\n    , @Color NVARCHAR(15)\r\n    , @SafetyStockLevel SMALLINT\r\n    , @ReorderPoint SMALLINT\r\n    , @StandardCost MONEY\r\n    , @ListPrice MONEY\r\n    , @DaysToManufacture INT\r\n    , @SellStartDate DATETIME\r\nAS\r\nBEGIN\r\n\r\n    -- Automatically roll back transactions if errors occur\r\n\r\n    SET XACT_ABORT, NOCOUNT ON \r\n\r\n    -- Validate input parameters\r\n\r\n    IF @SubcategoryName IS NULL\r\n        OR @ModelName IS NULL\r\n        OR @ProductName IS NULL\r\n        OR @ProductNumber IS NULL \r\n        -- OR entry for each of the other parameters\r\n    BEGIN\r\n        DECLARE @msg NVARCHAR(MAX) = N'One or more missing input parameters: ';\r\n        SET @msg += \r\n            (SELECT * \r\n            FROM \r\n                (VALUES (@SubcategoryName, @ModelName, @ProductName, @ProductNumber)) -- other parms\r\n                       v(SubcategoryName, ModelName, ProductName, ProductNumber)      -- other parms\r\n            FOR JSON AUTO, INCLUDE_NULL_VALUES\r\n            );\r\n        THROW 51000, @msg, 1;\r\n        RETURN -1;\r\n    END\r\n\r\n    -- Process the data in a TRY/CATCH loop\r\n\r\n    DECLARE @try int = 0, @tries int = 10;\r\n    DECLARE @en int;\r\n    DECLARE @delay datetime = '00:00:05'\r\n\r\n    WHILE @try < @tries BEGIN\r\n        SET @try += 1;\r\n        BEGIN TRY\r\n            BEGIN TRANSACTION;\r\n\r\n            IF Production.ufnGetProductSubcategoryID(@SubcategoryName) IS NULL\r\n            BEGIN\r\n                INSERT INTO Production.ProductSubcategory (\r\n                    ProductCategoryID\r\n                    , Name\r\n                    )\r\n                VALUES (\r\n                    Production.ufnGetProductCategoryID('Bikes')\r\n                    , @SubcategoryName\r\n                    );\r\n            END\r\n\r\n            IF Production.ufnGetProductModelID(@ModelName) IS NULL\r\n            BEGIN\r\n                INSERT INTO Production.ProductModel (Name)\r\n                VALUES (@ModelName);\r\n            END\r\n\r\n            -- Upsert Product Table\r\n\r\n            UPDATE Production.Product WITH (UPDLOCK, SERIALIZABLE) \r\n                SET \r\n                  Name                  = @ProductName\r\n                , Color                 = @Color\r\n                , SafetyStockLevel\t\t= @SafetyStockLevel\r\n                , ReorderPoint\t\t\t= @ReorderPoint\r\n                , StandardCost\t\t\t= @StandardCost\r\n                , ListPrice\t\t\t    = @ListPrice\r\n                , DaysToManufacture\t    = @DaysToManufacture\r\n                , ProductSubcategoryID\t= Production.ufnGetProductSubcategoryID(@SubcategoryName)\r\n                , ProductModelId\t\t= Production.ufnGetProductModelID(@ModelName)\r\n                , SellStartDate\t\t    = @SellStartDate\r\n            WHERE ProductNumber = @ProductNumber\r\n\r\n            IF @@ROWCOUNT = 0\r\n            BEGIN\r\n                INSERT INTO Production.Product (\r\n                    Name\r\n                    , ProductNumber\r\n                    , Color\r\n                    , SafetyStockLevel\r\n                    , ReorderPoint\r\n                    , StandardCost\r\n                    , ListPrice\r\n                    , DaysToManufacture\r\n                    , ProductSubcategoryID\r\n                    , ProductModelId\r\n                    , SellStartDate\r\n                    )\r\n                VALUES (\r\n                      @ProductName\r\n                    , @ProductNumber\r\n                    , @Color\r\n                    , @SafetyStockLevel\r\n                    , @ReorderPoint\r\n                    , @StandardCost\r\n                    , @ListPrice\r\n                    , @DaysToManufacture\r\n                    , Production.ufnGetProductSubcategoryID(@SubcategoryName)\r\n                    , Production.ufnGetProductModelID(@ModelName)\r\n                    , @SellStartDate\r\n                    );\r\n            END\r\n\r\n            COMMIT;\r\n            BREAK;\r\n        END TRY\r\n        BEGIN CATCH\r\n            SET @en = ERROR_NUMBER();\r\n            RAISERROR ('Caught error %i, iteration %i, trancount %i', 0, 1, @en, @try, @@TRANCOUNT) WITH NOWAIT;\r\n\r\n            IF @en = 2601 -- Cannot insert duplicate key row in object \r\n                BREAK;\r\n            IF @en IN (1205, 1222) -- Deadlock or Lock timeout\r\n            BEGIN\r\n                IF @@TRANCOUNT > 0\r\n                    ROLLBACK;\r\n                WAITFOR DELAY @delay;\r\n                CONTINUE;\r\n            END;\r\n\r\n            -- Rethrow the error if not handled\r\n            THROW;\r\n        END CATCH\r\n\r\n    END -- End of while loop\r\n\r\n    IF @@TRANCOUNT > 0\r\n        ROLLBACK;\r\n    IF @try > @tries\r\n    BEGIN\r\n        THROW 51000, 'Deadlock or lock timeout occurred, aborting operation', 1;\r\n    END\r\n\r\nEND\r\nGO\r\n\r\nBEGIN TRAN\r\n\r\nEXEC Production.AddNewBike 'Electric Bikes'\r\n    , 'Electric-100'\r\n    , 'Electric Red'\r\n    , 'BK-E10R-62'\r\n    , 'YELLOW'\r\n    , 1\r\n    , 1\r\n    , 100.00\r\n    , 200.00\r\n    , 1\r\n    , '20240601'\r\n\r\n/* -- \r\nDELETE FROM Production.Product WHERE ProductNumber LIKE 'BK-E10%'\r\nDELETE FROM Production.ProductSubcategory WHERE NAME LIKE 'Electric%'\r\nDELETE FROM Production.ProductModel WHERE NAME LIKE 'Electric%'\r\n-- */\r\n\r\nSELECT *\r\nFROM Production.Product\r\nWHERE ProductNumber = 'BK-E10R-62'\r\n\r\nROLLBACK\r\n\n"})})]})}function N(r={}){const{wrapper:n}={...(0,a.R)(),...r.components};return n?(0,o.jsx)(n,{...r,children:(0,o.jsx)(E,{...r})}):E(r)}},8453:(r,n,t)=>{t.d(n,{R:()=>c,x:()=>u});var e=t(6540);const o={},a=e.createContext(o);function c(r){const n=e.useContext(a);return e.useMemo(function(){return"function"==typeof r?r(n):{...n,...r}},[n,r])}function u(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(o):r.components||o:c(r.components),e.createElement(a.Provider,{value:n},r.children)}}}]);